// ===== MULTI-LANGUAGE PRESENTATION DATA =====
const translations = {
    en: {
        slides: [
            {
                text: "Virtual Twin of the Production System",
                media: null
            },
            {
                text: "The virtual twin of the production system brings everything together: machines, their kinematics and programs, operators and their skills, work instructions, material flows, manufacturing methods and automation resources.\n\nInside this virtual world, we deploy virtual companions.",
                media: "PSY 1"
            },
            {
                text: "Here's a concrete example: An aerospace and defense contract requires a 40% capacity increase on a critical assembly line. The virtual twin allows multiple layout scenarios, optimizes cycle times, proposes new line balancing strategies, validates operator movements in simulation, and anticipates ergonomic risks.",
                media: "PSY 2"
            },
            {
                text: "The virtual companion supports work instructions updates and execution.",
                media: "PSY 3"
            },
            {
                text: "Now virtual meets real. This is sense computing. On an assembly station, machine vision detects in real time potential errors, missing tools or incorrect component orientation. The operator receives contextual guidance in a hybrid virtual-real environment.",
                media: "PSY 4"
            },
            {
                text: "The result? Errors are prevented before they happen, and know-how is captured and continuously capitalized in order to ensure the right level of productivity to address the A&D market.",
                media: "PSY Content"
            }
        ],
        buttons: {
            start: "Start Presentation",
            continue: "Continue",
            finish: "Finish",
            restart: "Restart Presentation"
        },
        endScreen: "<strong>Thank you</strong><br>Presentation Complete"
    },
    fr: {
        slides: [
            {
                text: "Jumeau Virtuel du Système de Production",
                media: null
            },
            {
                text: "Le jumeau virtuel du système de production rassemble tout : machines, leurs cinématiques et programmes, opérateurs et leurs compétences, instructions de travail, flux de matériaux, méthodes de fabrication et ressources d'automatisation.\n\nDans ce monde virtuel, nous déployons des compagnons virtuels.",
                media: "PSY 1"
            },
            {
                text: "Voici un exemple concret : Un contrat aérospatial et défense nécessite une augmentation de capacité de 40% sur une ligne d'assemblage critique. Le jumeau virtuel permet de multiples scénarios de layout, optimise les temps de cycle, propose de nouvelles stratégies d'équilibrage de ligne, valide les mouvements des opérateurs en simulation et anticipe les risques ergonomiques.",
                media: "PSY 2"
            },
            {
                text: "Le compagnon virtuel soutient les mises à jour et l'exécution des instructions de travail.",
                media: "PSY 3"
            },
            {
                text: "Maintenant, le virtuel rencontre le réel. C'est le sense computing. Sur un poste d'assemblage, la vision machine détecte en temps réel les erreurs potentielles, les outils manquants ou l'orientation incorrecte des composants. L'opérateur reçoit un guidage contextuel dans un environnement hybride virtuel-réel.",
                media: "PSY 4"
            },
            {
                text: "Le résultat ? Les erreurs sont évitées avant qu'elles ne se produisent, et le savoir-faire est capturé et continuellement capitalisé afin d'assurer le bon niveau de productivité pour répondre au marché A&D.",
                media: "PSY Content"
            }
        ],
        buttons: {
            start: "Démarrer la Présentation",
            continue: "Continuer",
            finish: "Terminer",
            restart: "Redémarrer la Présentation"
        },
        endScreen: "<strong>Merci</strong><br>Présentation Terminée"
    },
    es: {
        slides: [
            {
                text: "Gemelo Virtual del Sistema de Producción",
                media: null
            },
            {
                text: "El gemelo virtual del sistema de producción reúne todo: máquinas, sus cinemáticas y programas, operadores y sus habilidades, instrucciones de trabajo, flujos de materiales, métodos de fabricación y recursos de automatización.\n\nDentro de este mundo virtual, desplegamos compañeros virtuales.",
                media: "PSY 1"
            },
            {
                text: "Aquí un ejemplo concreto: Un contrato aeroespacial y de defensa requiere un aumento de capacidad del 40% en una línea de ensamblaje crítica. El gemelo virtual permite múltiples escenarios de diseño, optimiza tiempos de ciclo, propone nuevas estrategias de equilibrio de línea, valida movimientos de operadores en simulación y anticipa riesgos ergonómicos.",
                media: "PSY 2"
            },
            {
                text: "El compañero virtual apoya las actualizaciones y ejecución de instrucciones de trabajo.",
                media: "PSY 3"
            },
            {
                text: "Ahora lo virtual se encuentra con lo real. Esto es sense computing. En una estación de ensamblaje, la visión artificial detecta en tiempo real errores potenciales, herramientas faltantes u orientación incorrecta de componentes. El operador recibe orientación contextual en un entorno híbrido virtual-real.",
                media: "PSY 4"
            },
            {
                text: "¿El resultado? Los errores se previenen antes de que ocurran, y el know-how se captura y capitaliza continuamente para asegurar el nivel correcto de productividad para abordar el mercado A&D.",
                media: "PSY Content"
            }
        ],
        buttons: {
            start: "Iniciar Presentación",
            continue: "Continuar",
            finish: "Finalizar",
            restart: "Reiniciar Presentación"
        },
        endScreen: "<strong>Gracias</strong><br>Presentación Completa"
    },
    de: {
        slides: [
            {
                text: "Virtueller Zwilling des Produktionssystems",
                media: null
            },
            {
                text: "Der virtuelle Zwilling des Produktionssystems bringt alles zusammen: Maschinen, ihre Kinematik und Programme, Bediener und ihre Fähigkeiten, Arbeitsanweisungen, Materialflüsse, Fertigungsmethoden und Automatisierungsressourcen.\n\nIn dieser virtuellen Welt setzen wir virtuelle Begleiter ein.",
                media: "PSY 1"
            },
            {
                text: "Hier ein konkretes Beispiel: Ein Luft- und Raumfahrt- & Verteidigungsvertrag erfordert eine 40%ige Kapazitätssteigerung an einer kritischen Montagelinie. Der virtuelle Zwilling ermöglicht mehrere Layout-Szenarien, optimiert Taktzeiten, schlägt neue Linienausgleichsstrategien vor, validiert Bedienerbewegungen in der Simulation und antizipiert ergonomische Risiken.",
                media: "PSY 2"
            },
            {
                text: "Der virtuelle Begleiter unterstützt Aktualisierungen und Ausführung von Arbeitsanweisungen.",
                media: "PSY 3"
            },
            {
                text: "Jetzt trifft virtuell auf real. Das ist Sense Computing. An einer Montagestation erkennt maschinelles Sehen in Echtzeit potenzielle Fehler, fehlende Werkzeuge oder falsche Komponentenausrichtung. Der Bediener erhält kontextuelle Anleitung in einer hybriden virtuell-realen Umgebung.",
                media: "PSY 4"
            },
            {
                text: "Das Ergebnis? Fehler werden verhindert, bevor sie passieren, und Know-how wird erfasst und kontinuierlich kapitalisiert, um das richtige Produktivitätsniveau für den A&D-Markt zu gewährleisten.",
                media: "PSY Content"
            }
        ],
        buttons: {
            start: "Präsentation Starten",
            continue: "Weiter",
            finish: "Beenden",
            restart: "Präsentation Neustarten"
        },
        endScreen: "<strong>Vielen Dank</strong><br>Präsentation Abgeschlossen"
    },
    zh: {
        slides: [
            {
                text: "生产系统虚拟孪生",
                media: null
            },
            {
                text: "生产系统虚拟孪生将一切整合在一起：机器、它们的运动学和程序、操作员及其技能、工作指令、物料流、制造方法和自动化资源。\n\n在这个虚拟世界中，我们部署虚拟助手。",
                media: "PSY 1"
            },
            {
                text: "这里有一个具体例子：一份航空航天和国防合同要求在关键装配线上提高40%的产能。虚拟孪生允许多种布局场景，优化周期时间，提出新的生产线平衡策略，在模拟中验证操作员动作并预测人体工程学风险。",
                media: "PSY 2"
            },
            {
                text: "虚拟助手支持工作指令的更新和执行。",
                media: "PSY 3"
            },
            {
                text: "现在虚拟与现实相遇。这就是感知计算。在装配站，机器视觉实时检测潜在错误、缺失工具或不正确的组件方向。操作员在虚拟-现实混合环境中获得情境指导。",
                media: "PSY 4"
            },
            {
                text: "结果呢？错误在发生之前就被预防，know-how被捕获并持续积累，以确保正确的生产力水平来应对航空航天和国防市场。",
                media: "PSY Content"
            }
        ],
        buttons: {
            start: "开始演示",
            continue: "继续",
            finish: "完成",
            restart: "重新开始演示"
        },
        endScreen: "<strong>谢谢</strong><br>演示完成"
    }
};

// ===== STATE MANAGEMENT =====
let currentSlide = -1;
let activeMedia = null;
let soundStarted = false;
let currentLanguage = 'en';

// ===== SUPABASE STATE =====
let supabaseClient = null;
let realtimeChannel = null;
let sessionId = null;
let isLocalAction = false;

// Get current slides based on selected language
function getSlides() {
    return translations[currentLanguage].slides;
}

function getButtonText(key) {
    return translations[currentLanguage].buttons[key];
}

function getEndScreenText() {
    return translations[currentLanguage].endScreen;
}

// ===== SDK INTEGRATION =====
function toggleVisibility(actorName, visible) {
    console.log("toggleVisibility:", actorName, visible);
    window.parent.postMessage(JSON.stringify({
        action: "toggleVisibility",
        actor: actorName,
        visible: visible
    }), "*");
}

function showMedia(mediaName) {
    if (mediaName) {
        toggleVisibility(mediaName, true);
        activeMedia = mediaName;
        console.log(`Showing 3D object: ${mediaName}`);
    }
}

function hideMedia(mediaName) {
    if (mediaName) {
        toggleVisibility(mediaName, false);
        console.log(`Hiding 3D object: ${mediaName}`);
    }
}

function hideAllMedia() {
    const allMedia = ["PSY 1", "PSY 2", "PSY 3", "PSY 4", "PSY 5", "PSY Content"];
    allMedia.forEach(media => {
        toggleVisibility(media, false);
    });
    activeMedia = null;
    console.log("All 3D objects hidden");
}

function hideASISProduction() {
    toggleVisibility("AS IS Production", false);
    console.log("AS IS Production hidden");
}

// ===== LANGUAGE SELECTOR =====
function changeLanguage(lang) {
    currentLanguage = lang;
    console.log('Language changed to:', lang);

    if (currentSlide >= 0 && currentSlide < getSlides().length) {
        const slideText = document.querySelector('.slide-text');
        slideText.textContent = getSlides()[currentSlide].text;
    }

    const nextBtn = document.getElementById('nextBtn');
    const btnText = nextBtn.querySelector('.btn-text');

    if (currentSlide === -1) {
        btnText.textContent = getButtonText('start');
    } else if (currentSlide === getSlides().length - 1) {
        btnText.textContent = getButtonText('finish');
    } else if (currentSlide >= getSlides().length) {
        btnText.textContent = getButtonText('restart');
    } else {
        btnText.textContent = getButtonText('continue');
    }

    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
    });
}

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', async () => {
    initStars();
    await initSupabase();
    initPresentation();
    initLanguageSelector();

    console.log("Production System Presentation loaded - SDK ready");
    console.log("Supabase Real-time sync enabled - User ID:", window.USER_ID);
});

// ===== STARS CREATION =====
function initStars() {
    const starsContainer = document.getElementById('stars');
    const starCount = 150;

    for (let i = 0; i < starCount; i++) {
        const star = document.createElement('div');
        star.className = 'star';

        const size = Math.random() * 2 + 0.5;
        star.style.width = size + 'px';
        star.style.height = size + 'px';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.animationDelay = Math.random() * 3 + 's';
        star.style.animationDuration = (Math.random() * 2 + 2) + 's';

        starsContainer.appendChild(star);
    }
}

// ===== LANGUAGE SELECTOR INITIALIZATION =====
function initLanguageSelector() {
    const languageSelector = document.getElementById('languageSelector');

    languageSelector.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            changeLanguage(btn.dataset.lang);
        });
    });
}

// ===== PRESENTATION LOGIC =====
function initPresentation() {
    const nextBtn = document.getElementById('nextBtn');
    const textContent = document.getElementById('textContent');

    hideAllMedia();
    toggleVisibility("Manufacturing Sound", false);

    setTimeout(() => {
        textContent.classList.add('show');
        nextBtn.classList.add('show');
    }, 300);

    nextBtn.addEventListener('click', nextSlide);
    updateProgress();
}

async function nextSlide() {
    if (!isLocalAction) {
        await updateSession({ current_slide: currentSlide + 1 });
    }

    nextSlideLocal();
}

function nextSlideLocal() {
    const textContent = document.getElementById('textContent');
    const slideText = textContent.querySelector('.slide-text');
    const nextBtn = document.getElementById('nextBtn');

    if (!soundStarted) {
        toggleVisibility("Manufacturing Sound", true);
        soundStarted = true;
    }

    currentSlide++;

    if (currentSlide >= getSlides().length) {
        showEndScreen();
        return;
    }

    textContent.classList.remove('show');
    textContent.classList.add('slide-out');

    setTimeout(() => {
        const slide = getSlides()[currentSlide];
        slideText.textContent = slide.text;

        if (slide.media) {
            showMedia(slide.media);

            if (slide.media === "PSY Content") {
                hideASISProduction();
            }
        }

        textContent.classList.remove('slide-out');
        textContent.classList.add('slide-in');

        setTimeout(() => {
            textContent.classList.remove('slide-in');
            textContent.classList.add('show');
        }, 100);

        if (currentSlide === getSlides().length - 1) {
            nextBtn.querySelector('.btn-text').textContent = getButtonText('finish');
        } else {
            nextBtn.querySelector('.btn-text').textContent = getButtonText('continue');
        }

        updateProgress();
    }, 500);
}

function showEndScreen() {
    const textContent = document.getElementById('textContent');
    const slideText = textContent.querySelector('.slide-text');
    const nextBtn = document.getElementById('nextBtn');

    textContent.classList.remove('show');
    nextBtn.classList.remove('show');

    setTimeout(() => {
        slideText.innerHTML = getEndScreenText();
        textContent.classList.add('show');

        nextBtn.querySelector('.btn-text').textContent = getButtonText('restart');
        nextBtn.querySelector('.btn-icon').textContent = '↻';
        nextBtn.onclick = restartPresentation;

        setTimeout(() => {
            nextBtn.classList.add('show');
        }, 500);
    }, 600);
}

async function restartPresentation() {
    if (!isLocalAction) {
        await updateSession({ current_slide: -1 });
    }

    restartPresentationLocal();
}

function restartPresentationLocal() {
    hideAllMedia();
    toggleVisibility("AS IS Production", true);
    toggleVisibility("Manufacturing Sound", false);

    currentSlide = -1;
    soundStarted = false;

    const nextBtn = document.getElementById('nextBtn');
    nextBtn.querySelector('.btn-text').textContent = getButtonText('start');
    nextBtn.querySelector('.btn-icon').textContent = '→';
    nextBtn.onclick = nextSlide;

    const textContent = document.getElementById('textContent');
    const slideText = textContent.querySelector('.slide-text');
    slideText.textContent = '';

    updateProgress();

    console.log("Presentation restarted");
}

function updateProgress() {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    const total = getSlides().length;
    const current = Math.max(0, currentSlide + 1);
    const percentage = (current / total) * 100;

    const barFill = document.createElement('div');
    barFill.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: ${percentage}%;
        background: linear-gradient(90deg, #1976d2, #4da6ff);
        border-radius: 10px;
        transition: width 0.6s ease;
        box-shadow: 0 0 10px rgba(77, 166, 255, 0.8);
    `;

    progressBar.innerHTML = '';
    progressBar.appendChild(barFill);

    progressText.textContent = `${current} / ${total}`;
}

// ===== SUPABASE INITIALIZATION =====
async function initSupabase() {
    const { createClient } = supabase;
    supabaseClient = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

    const { data, error } = await supabaseClient
        .from('production_presentation_session')
        .select('*')
        .single();

    if (error) {
        console.error('Error fetching Production presentation session:', error);
        return;
    }

    sessionId = data.id;
    console.log('Connected to Production presentation session:', sessionId);

    realtimeChannel = supabaseClient
        .channel('production_presentation_session_changes')
        .on(
            'postgres_changes',
            {
                event: 'UPDATE',
                schema: 'public',
                table: 'production_presentation_session'
            },
            handleSessionUpdate
        )
        .subscribe();

    console.log('Production Real-time subscription active');

    console.log('Current session state:', data.current_slide);
    if (data.current_slide > -1) {
        console.log('Presentation already in progress - waiting for real-time updates');
    }
}

// ===== SUPABASE SYNC FUNCTIONS =====
async function updateSession(updates) {
    const { error } = await supabaseClient
        .from('production_presentation_session')
        .update(updates)
        .eq('id', sessionId);

    if (error) {
        console.error('Error updating Production session:', error);
    }
}

function handleSessionUpdate(payload) {
    const newData = payload.new;
    console.log('Presentation session updated:', newData);

    if (newData.current_slide !== currentSlide) {
        syncToSlide(newData.current_slide);
    }
}

function syncToSlide(targetSlide) {
    isLocalAction = true;

    const diff = targetSlide - currentSlide;

    if (diff === 1) {
        nextSlideLocal();
    } else if (targetSlide === -1 && currentSlide !== -1) {
        restartPresentationLocal();
    }

    isLocalAction = false;
}
